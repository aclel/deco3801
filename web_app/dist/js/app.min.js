!function(){"use strict";angular.module("app",["app.core","app.gui","app.auth","app.nav","app.dashboard","app.config","app.warnings","app.admin"])}(),function(){"use strict";angular.module("app.admin",["app.core","app.gui"])}(),function(){"use strict";angular.module("app.auth",[])}(),function(){"use strict";angular.module("app.config",["app.core","app.gui","ui.tree"])}(),function(){"use strict";angular.module("app.core",["ui.router"])}(),function(){"use strict";angular.module("app.dashboard",["app.core","app.gui","chart.js","ui.indeterminate"])}(),function(){"use strict";angular.module("app.gui",["ngAnimate","mgcrea.ngStrap","mgcrea.ngStrap.helpers.dimensions","mgcrea.ngStrap.helpers.dateParser","mgcrea.ngStrap.helpers.parseOptions","mgcrea.ngStrap.tooltip","mgcrea.ngStrap.datepicker","mgcrea.ngStrap.timepicker","mgcrea.ngStrap.button","mgcrea.ngStrap.select","mgcrea.ngStrap.modal","mgcrea.ngStrap.alert","mgcrea.ngStrap.tab","mgcrea.ngStrap.dropdown"])}(),function(){"use strict";angular.module("app.nav",["app.core","app.auth","app.gui"])}(),function(){"use strict";angular.module("app.warnings",["app.core","app.gui"])}(),function(){"use strict";angular.module("app").constant("moment",moment).constant("google",google)}(),function(){"use strict";angular.module("app").constant("SERVER_ADDRESS","http://teamneptune.co")}(),function(){"use strict";function e(e,n,t){function r(){o()}function o(){n.getUsers().then(function(e){m.users=e.data.users,a()},function(e){t.alertBadResponse(e)})}function a(){m.users.forEach(function(e){e.lastLogin.Valid?e.lastLogin.text=moment(e.lastLogin.Time).fromNow():e.lastLogin.text="Never"})}function s(e){m.editUserId=e.id,m.editUser=e}function i(){-2!=m.editUserId?n.updateUser(m.editUser).then(function(e){o(),t.alertSuccess("User updated.")},function(e){t.alertBadResponse(e)}):(n.addUser(m.editUser).then(function(e){o(),t.alertSuccess("User added.")},function(e){t.alertBadResponse(e)}),m.users.splice(m.users.length-1,1)),m.editUserId=-1}function u(){-2==m.editUserId&&m.users.splice(m.users.length-1,1),m.editUserId=-1}function c(e){n.deleteUser(e.id).then(function(e){o(),t.alertSuccess("User deleted.")},function(e){t.alertBadResponse(e)})}function d(n){m.deleteObject=n,m.deleteType="user",m.deleteName=n.email,t.confirmDelete(e)}function p(e){return(-1==m.editUserId||m.editUserId==e.id)&&-2!=e.id}function l(){var e={id:-2,role:m.roles[0]};m.users.push(e),s(e)}function f(){if(""!=m.newBuoyName){var e=g();n.addBuoy(m.newBuoyName,e).then(function(e){t.alertSuccess("Buoy created.")},function(e){t.alertBadResponse(e)}),m.newBuoyName=""}}function g(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var n=16*Math.random()|0,t="x"==e?n:3&n|8;return t.toString(16)})}var m=this;m.users=[],m.editUserId=-1,m.newBuoyName="",m.roles=["user","power_user","system_admin"],m.confirmDelete=c,m.startEditingUser=s,m.finishEditingUser=i,m.deleteUser=d,m.cancelEditingUser=u,m.startAddingUser=l,m.showDeleteButton=p,m.addBuoy=f,r()}angular.module("app.admin").controller("AdminController",e),e.$inject=["$scope","server","gui"]}(),function(){"use strict";function e(e){e.configureStates(n())}function n(){return[{state:"admin",config:{url:"/admin",controller:"AdminController",controllerAs:"vm",templateUrl:"/app/admin/admin.html",data:{access:"system_admin"}}}]}angular.module("app.admin").run(e),e.$inject=["routerHelper"]}(),function(){"use strict";function e(e,n,t){function r(e,r,o,a,s){t.checkUser(r.data.access)||(e.preventDefault(),"^"===a.url&&(t.loggedIn()?n.go("dashboard"):n.go("login")))}e.$on("$stateChangeStart",r)}angular.module("app.auth").run(e),e.$inject=["$rootScope","$state","auth"]}(),function(){"use strict";function e(e,n,t,r,o,a){function s(){l(),e.$on("$stateChangeSuccess",i)}function i(){(n.is("change_password")||n.is("reset_password")||n.is("forgot_password"))&&(g.changePasswordResponse=-1,g.forgotResponse=-1,g.waiting=!1,f(),l())}function u(){o.login(g.email,g.password).then(function(e){console.log(e),r.loggedIn()&&(e.data.lastLogin.Valid?n.go("dashboard"):(n.go("reset_password"),g.firstLogin=!0),l())},function(e){alert("Invalid email or password")})}function c(){g.waiting=!0,""!=g.newPassword&&g.newPassword==g.confirmPassword?o.changePassword(g.currentPassword,g.newPassword).then(function(e){g.changePasswordResponse=0},function(e){g.changePasswordResponse=1}):alert("Invalid password")}function d(){g.waiting=!0,""!=g.newPassword&&g.newPassword==g.confirmPassword?o.resetPassword(t.token+"=",g.newPassword).then(function(e){g.changePasswordResponse=0,g.firstLogin=!1},function(e){g.changePasswordResponse=1}):alert("Invalid password")}function p(){g.waiting=!0,o.forgotPassword(g.email).then(function(e){g.forgotResponse=0},function(e){g.forgotResponse=1})}function l(){g.email="",g.password=""}function f(){g.currentPassword="",g.newPassword="",g.confirmPassword=""}var g=this;g.firstLogin=!1,g.login=u,g.forgotResponse=-1,g.changePasswordResponse=-1,g.waiting=!1,g.changePassword=c,g.forgotPassword=p,g.resetPassword=d,s()}angular.module("app.auth").controller("AuthController",e),e.$inject=["$scope","$state","$stateParams","auth","server","routerHelper"]}(),function(){"use strict";function e(e){e.configureStates(n())}function n(){return[{state:"login",config:{url:"/login",templateUrl:"/app/auth/login.html",data:{access:"unauthed"}}},{state:"change_password",config:{url:"/change_password",templateUrl:"/app/auth/change_password.html",data:{access:"authed"}}},{state:"reset_password",config:{url:"/reset_password?token",templateUrl:"/app/auth/reset_password.html",data:{access:"unauthed"}}},{state:"forgot_password",config:{url:"/forgot_password",templateUrl:"/app/auth/forgot_password.html",data:{access:"unauthed"}}}]}angular.module("app.auth").run(e),e.$inject=["routerHelper"]}(),function(){"use strict";function e(e,n){function t(){e.localStorage.removeItem("token")}function r(){var e=a();if(e){var t=c(e);return n().unix()<=t.exp}return!1}function o(n){e.localStorage.token=n}function a(){return e.localStorage.token}function s(){return c(a()).sub}function i(){var e=a();return null==e?"unauthed":c(e).role}function u(e){var n={unauthed:0,authed:1,user:1,power_user:2,system_admin:3,andrew:99999};if("any"==e)return!0;if("unauthed"==e){if(r())return!1}else if(!r())return!1;return n[i()]>=n[e]}function c(n){var t=n.split(".")[1],r=t.replace("-","+").replace("_","/");return JSON.parse(e.atob(r))}return{logout:t,loggedIn:r,getToken:a,saveToken:o,currentUser:s,checkUser:u}}angular.module("app.auth").factory("auth",e),e.$inject=["$window","moment"]}(),function(){"use strict";function e(e){function n(e){return e}function t(n){return n.data.token&&e.saveToken(n.data.token),n}return{request:n,response:t}}angular.module("app.auth").factory("authInterceptor",e),e.$inject=["auth"]}(),function(){"use strict";function e(e,n){function t(){o(),a(),s(),u(),D(),r()}function r(){W.treeOptions={accept:function(e,n,t){if("instance"!=e.$modelValue.type){if(n.depth()>0)return!1}else{if(1!=n.depth())return!1;if(null!=n.childNodes()[t]&&n.childNodes()[t].collapsed)return!1}return!0},dropped:function(e){},dragStart:function(e){var n=e.source.nodeScope;"group"==n.$modelValue.type?y(n.$modelValue):h(n.$modelValue)}}}function o(){e.getBuoyGroups().then(function(e){W.buoyGroups=e.data.buoyGroups,d()},function(e){n.alertBadResponse(e)})}function a(){e.getBuoyInstances().then(function(e){W.buoyInstances=e.data.buoyInstances,d()},function(e){n.alertBadResponse(e)})}function s(){e.getCommandTypes().then(function(e){W.commandTypes=e.data.commandTypes,i()},function(e){n.alertBadResponse(e)})}function i(){e.getBuoyCommands().then(function(e){W.commands=e.data.commands,E()},function(e){n.alertBadResponse(e)})}function u(){e.getWarningTriggers().then(function(e){W.warningTriggers=e.data.warningTriggers,c()},function(e){n.alertBadResponse(e)})}function c(){e.getSensorTypes().then(function(e){W.sensorTypes=e.data.sensorTypes,p()},function(e){n.alertBadResponse(e)})}function d(){b(),W.buoyInstances.forEach(function(e){v(e),e.type="instance"})}function p(){W.warningTriggers.forEach(function(e){for(var n=0;n<W.buoyInstances.length;n++){var t=W.buoyInstances[n];if(t.id==e.buoyInstanceId){e.buoyName=t.name;break}}for(var n=0;n<W.sensorTypes.length;n++){var r=W.sensorTypes[n];if(r.id==e.sensorTypeId){e.sensorName=r.name;break}}})}function l(){return"instance"==W.selected.type?!0:"group"==W.selected.type&&W.groupBuoys.length>0?!0:"all"==W.selected.type&&W.buoyInstances.length>0?!0:!1}function f(){W.groupBuoys=[],W.buoyInstances.forEach(function(e){e.buoyGroupId==W.selected.obj.id&&W.groupBuoys.push(e)})}function g(){m(),W.selected.type="all"}function m(){W.editName.on=!1,W.editGroup.on=!1,W.newCommand=!1,W.newTrigger=!1}function y(e){m(),W.selected.type="group",W.selected.obj=e,f()}function h(e){m(),W.selected.type="instance",W.selected.obj=e,f()}function b(){W.buoyGroups.forEach(function(e){e.type="group",e.buoyInstances=[]})}function v(e){W.buoyGroups.forEach(function(n){return n.id==e.buoyGroupId?(e.buoyGroupName=q(n.name),void n.buoyInstances.push(e)):void 0})}function w(e){e.collapsed=!e.collapsed}function I(){W.editName.on=!0}function T(){W.editName.on=!1,"group"==W.selected.type?e.updateBuoyGroupName(W.selected.obj.id,W.selected.obj.name).then(function(e){o(),n.alertSuccess("Name updated.")},function(e){n.alertBadResponse(e)}):"instance"==W.selected.type&&e.updateBuoyInstanceName(W.selected.obj.id,W.selected.obj.name,W.selected.obj.buoyGroupId).then(function(e){a(),n.alertSuccess("Name updated.")},function(e){n.alertBadResponse(e)})}function B(){W.editName.on=!1}function x(){W.editGroup.on=!0,W.editGroup.buoyGroupId=W.selected.obj.buoyGroupId}function S(){W.editGroup.on=!1,W.selected.obj.buoyGroupId=W.editGroup.buoyGroupId,setBuoyGroupName(W.selected.obj),e.updateBuoyInstanceGroup(W.selected.obj.buoyId,W.editGroup.buoyGroupId,W.editGroup.name).then(function(e){a(),n.alertSuccess("New buoy instance created.")},function(e){n.alertBadResponse(e)})}function N(){W.editGroup.on=!1}function $(){return W.editName.on?!0:W.editGroup.on?!0:W.newCommand?!0:W.newTrigger?!0:!1}function C(){W.selected.type="newGroup",W.selected.obj=null}function G(){e.newBuoyGroup(W.editName.value).then(function(e){W.selected.type="all",o(),n.alertSuccess("New group created.")},function(e){n.alertBadResponse(e)})}function E(){W.commands.forEach(function(e){for(var n=0;n<W.buoyInstances.length;n++){var t=W.buoyInstances[n];if(e.buoyId==t.buoyId){e.buoyName=t.name,""==e.buoyName&&(e.buoyName="(no name)");break}}for(var n=0;n<W.commandTypes.length;n++)if(e.commandTypeId==W.commandTypes[n].id){e.commandName=W.commandTypes[n].name;break}})}function R(){if(-1!=W.command.id&&""!=W.command.value){W.newCommand=!1;var e=[];"instance"==W.selected.type?e.push(W.selected.obj.buoyId):"group"==W.selected.type?W.buoyInstances.forEach(function(n){n.buoyGroupId==W.selected.obj.id&&e.push(n.buoyId)}):"all"==W.selected.type&&W.buoyInstances.forEach(function(n){e.push(n.buoyId)}),P(e),j()}}function j(){W.command.id=-1,W.command.value=""}function k(){W.newCommand=!1,j()}function P(t){e.sendBuoyCommand(W.command,t).then(function(e){i(),n.alertSuccess("Command queued.")},function(e){n.alertBadResponse(e)})}function _(e){}function U(){if(-1!=W.trigger.sensorTypeId&&""!=W.trigger.value){W.newTrigger=!1;var e=[];"instance"==W.selected.type?e.push(W.selected.obj.id):"group"==W.selected.type?W.buoyInstances.forEach(function(n){n.buoyGroupId==W.selected.obj.id&&e.push(n.id)}):"all"==W.selected.type&&W.buoyInstances.forEach(function(n){e.push(n.id)}),M(e),D()}}function M(t){e.addWarningTriggers(W.trigger,t).then(function(e){u(),n.alertSuccess("Warning trigger added.")},function(e){n.alertBadResponse(e)})}function D(){W.trigger={sensorTypeId:-1,operator:"<",value:"",message:""}}function O(){W.newTrigger=!1,D()}function A(e){return 0!=e.id?!0:!1}function L(e){return"all"==W.selected.type?!0:"instance"==W.selected.type?J(e):"group"==W.selected.type?H(e):!1}function J(e){return e.buoyId==W.selected.obj.buoyId?!0:!1}function H(e){for(var n=0;n<W.buoyInstances.length;n++){var t=W.buoyInstances[n];if(t.buoyGroupId==W.selected.obj.id&&e.buoyId==t.buoyId)return!0}return!1}function q(e){return"("==e[0]&&(e=e.substr(1)),")"==e[e.length-1]&&(e=e.substr(0,e.length-1)),e}var W=this;W.buoyGroups=[],W.buoyInstances=[],W.groupBuoys=[],W.commands=[],W.commandTypes=[],W.sensorTypes=[],W.warningTriggers=[],W.command={id:-1,value:""},W.selected={type:"all",obj:null},W.editName={},W.editName.on=!1,W.editGroup={},W.editGroup.on=!1,W.newCommand=!1,W.newTrigger=!1,W.operators=["<",">","="],W.trigger={},W.treeOptions={},W.selectAll=g,W.selectBuoyGroup=y,W.selectBuoyInstance=h,W.startEditingName=I,W.finishEditingName=T,W.startEditingBuoyGroup=x,W.finishEditingBuoyGroup=S,W.selectNewBuoyGroup=C,W.saveNewBuoyGroup=G,W.buoyGroupFilter=A,W.commandFilter=L,W.sendCommand=R,W.deleteCommand=_,W.showBuoyConfig=l,W.addTrigger=U,W.cancelNewCommand=k,W.cancelNewTrigger=O,W.editing=$,W.cancelEditName=B,W.cancelEditGroup=N,W.toggleBuoyGroup=w,t()}angular.module("app.config").controller("ConfigController",e),e.$inject=["server","gui"]}(),function(){"use strict";function e(e){e.configureStates(n())}function n(){return[{state:"config",config:{url:"/config",controller:"ConfigController",controllerAs:"vm",templateUrl:"/app/config/config.html",data:{access:"power_user"}}}]}angular.module("app.config").run(e),e.$inject=["routerHelper"]}(),function(){"use strict";function e(e){var t="/hello";e.configureStates(n(),t)}function n(){return[{state:"hello",config:{url:"/hello",controller:"HelloController",data:{access:"any"}}}]}angular.module("app.core").run(e),e.$inject=["routerHelper"]}(),function(){"use strict";function e(e,n){function t(){n.debug("howdy"),e.go("dashboard"),e.includes("hello")&&e.go("login")}t()}angular.module("app.core").controller("HelloController",e),e.$inject=["$state","$log"]}(),function(){"use strict";function e(e,n,t){function r(e){function r(e,r){e.forEach(function(e){n.state(e.state,e.config)}),r&&!s&&(s=!0,t.otherwise(r))}function o(){return e.get()}function a(n){return e.includes(n)}var s=!1;return{configureStates:r,getStates:o,stateActive:a}}this.$get=r,r.$inject=["$state"]}angular.module("app.core").provider("routerHelper",e),e.$inject=["$locationProvider","$stateProvider","$urlRouterProvider"]}(),function(){"use strict";function e(e,n,t,r,o){function a(){return{headers:{}}}function s(e){return e.headers.Authorization="Bearer "+r.getToken(),e}function i(e){return e.headers["Content-Type"]="application/json",e}function u(n,r){var o={email:n,password:r};return e.post(t+"/api/login",JSON.stringify(o))}function c(){r.logout()}function d(n,o){var i=s(a()),u={currentPassword:n,newPassword:o},c=r.currentUser();return e.put(t+"/api/users/"+c+"/change_password",JSON.stringify(u),i)}function p(n,r){var o={newPassword:r},a="?token="+n;return e.post(t+"/api/reset_password"+a,JSON.stringify(o))}function l(n){var r={email:n};return e.post(t+"/api/forgot_password",JSON.stringify(r))}function f(n,r){var o=s(a()),i="?start_time="+n+"&end_time="+r;return e.get(t+"/api/readings"+i,o)}function g(){var n=s(a());return e.get(t+"/api/buoy_groups",n)}function m(){var n=s(a());return e.get(t+"/api/buoy_instances?active=true",n)}function y(n,r){var o=i(s(a())),u={name:r};return e.put(t+"/api/buoy_groups/"+n,JSON.stringify(u),o)}function h(n,r,o){var u=i(s(a())),c={name:r,buoyGroupId:o};return e.put(t+"/api/buoy_instances/"+n,JSON.stringify(c),u)}function b(n){var r=i(s(a())),o={name:n};return e.post(t+"/api/buoy_groups",JSON.stringify(o),r)}function v(n,r,o){var u=i(s(a())),c={name:o,buoyId:n,buoyGroupId:r};return e.post(t+"/api/buoy_instances",JSON.stringify(c),u)}function w(){var n=s(a());return e.get(t+"/api/command_types",n)}function I(){var n=s(a());return e.get(t+"/api/commands?sent=false",n)}function T(r){var i=s(a());i.responseType="arraybuffer",i.headers.Accept="text/csv";var u={readings:r},c=e.post(t+"/api/readings/export",JSON.stringify(u),i);return c.then(function(e){var n=o().format("DD-MM-YY-HHmmss"),t="export-"+n+".csv";B(t,e.data,"text/csv")},function(e){n.error(e)}),c}function B(e,n,t){var r=new Blob([n],{type:t});saveAs(r,e)}function x(n,r){var o=i(s(a())),u={commands:[]};return r.forEach(function(e){u.commands.push({commandTypeId:n.id,value:parseInt(n.value,10),buoyId:e})}),e.post(t+"/api/commands",JSON.stringify(u),o)}function S(e){}function N(){var n=s(a());return e.get(t+"/api/warning_triggers?active_instances=true",n)}function $(n,r){var o=i(s(a())),u={warningTriggers:[]};return r.forEach(function(e){u.warningTriggers.push({buoyInstanceId:e,sensorTypeId:n.sensorTypeId,operator:n.operator,value:parseInt(n.value,10),message:n.message})}),e.post(t+"/api/warning_triggers",JSON.stringify(u),o)}function C(){var n=s(a());return e.get(t+"/api/warnings",n)}function G(){var n=s(a());return e.get(t+"/api/sensor_types",n)}function E(){var n=s(a());return e.get(t+"/api/users",n)}function R(n){var r=i(s(a())),o={email:n.email,firstName:n.firstName,lastName:n.lastName,role:n.role};return e.post(t+"/api/users",JSON.stringify(o),r)}function j(n){var r=i(s(a())),o={firstName:n.firstName,lastName:n.lastName,role:n.role};return e.put(t+"/api/users/"+n.id,JSON.stringify(o),r)}function k(n){var r=s(a());return e["delete"](t+"/api/users/"+n,r)}function P(n,r){var o=i(s(a())),u={guid:r,name:n};return e.post(t+"/api/buoys",JSON.stringify(u),o)}return{login:u,logout:c,changePassword:d,resetPassword:p,forgotPassword:l,getReadings:f,getBuoyGroups:g,getBuoyInstances:m,updateBuoyGroupName:y,updateBuoyInstanceName:h,newBuoyGroup:b,updateBuoyInstanceGroup:v,getCommandTypes:w,getBuoyCommands:I,exportData:T,sendBuoyCommand:x,getWarningTriggers:N,addWarningTriggers:$,getWarnings:C,getSensorTypes:G,getUsers:E,addUser:R,updateUser:j,deleteUser:k,deleteBuoyCommand:S,addBuoy:P}}angular.module("app").factory("server",e),e.$inject=["$http","$log","SERVER_ADDRESS","auth","moment"]}(),function(){"use strict";function e(){function e(){return[{id:1,buoy:1,timestamp:1438933614,latitude:-27.44613423,longitude:153.07834625,readings:{battery:90,pressure:140,sealevel:21,turbidity:14}},{id:2,buoy:2,timestamp:1438588117,latitude:-27.42693772,longitude:153.20674896,readings:{battery:70,pressure:122,sealevel:44,turbidity:4}},{id:3,buoy:2,timestamp:1438760876,latitude:-27.491475,longitude:153.006655,readings:{battery:45,pressure:85,sealevel:15,turbidity:45}},{id:4,buoy:4,timestamp:1438847291,latitude:-27.400357,longitude:153.177995,readings:{battery:75,pressure:97,sealevel:33,turbidity:66}},{id:77,buoy:1,timestamp:1438328839,latitude:-27.44713423,longitude:153.09234625,readings:{battery:83,pressure:118,sealevel:24.5,turbidity:8}}]}function n(){return[{id:"battery",name:"Battery",description:"Battery level of buoy",colour:"",units:"%",lowerBound:0,upperBound:100,display:!0,unconfigured:!1},{id:"turbidity",name:"Turbidity",description:"Water quality around buoy",colour:"",units:"g/ml",lowerBound:0,upperBound:70,display:!0,unconfigured:!1},{id:"pressure",name:"",description:"",colour:"",units:"",lowerBound:-1,upperBound:-1,display:!1,unconfigured:!0}]}function t(){}function r(){}return{getReadings:e,getSensors:n,login:t,logout:r}}angular.module("mock.server",[]).factory("server",e)}(),function(){"use strict";angular.module("app.dashboard").config(["ChartJsProvider",function(e){e.setOptions({responsive:!0})}])}(),function(){"use strict";function e(e,n,t,r,o){function a(){l.loading=!0,f=0,s(),i(),t.$on("displayChartInstance",function(e,n){t.$apply(function(){l.showGraphs||d(),r.displayChartInstance(n.name)})}),t.$on("create",function(e,n){p=n})}function s(){r.queryReadings().then(function(){c()})}function i(){r.querySensors().then(function(){l.sensors=r.sensors(),c()})}function u(){l.loading=!0,r.updateTimes().then(function(){l.loading=!1})}function c(){2==++f&&(l.loading=!1)}function d(){l.showGraphs=!l.showGraphs;var e=o.getCenter();angular.element(document.getElementsByClassName("dashboard-panel")).one("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){o.setCenter(e),p.resize(p.render)})}var p,l=this,f=0;l.loading=!1,l.showGraphs=!1,l.buoys=r.buoys(),l.times=r.times(),l.sensors=r.sensors(),l.chart=r.chart(),l.selectBuoyGroup=r.selectBuoyGroup,l.selectBuoyInstance=r.selectBuoyInstance,l.updateSensors=r.updateSensors,l.updateTimes=u,l.exportData=r.exportData,l.toggleGraphs=d,a(),n.ready(function(){o.initialiseMap()})}angular.module("app.dashboard").controller("DashboardController",e),e.$inject=["$log","$document","$scope","dashboard","map"]}(),function(){"use strict";function e(e){var t="/dashboard";e.configureStates(n(),t)}function n(){return[{state:"dashboard",config:{url:"/dashboard",controller:"DashboardController",controllerAs:"vm",templateUrl:"/app/dashboard/dashboard.html",data:{access:"authed"}}}]}angular.module("app.dashboard").run(e),e.$inject=["routerHelper"]}(),function(){"use strict";function e(e,n,t,r,o){function a(){return V}function s(){return Y}function i(){return F}function u(){return X}function c(n,r){n||(n=o().subtract(Y.inputs.since.value,Y.inputs.since.quantifier).unix(),r=o().unix());var a=t.getReadings(n,r);return a.then(function(e){W=e.data.buoyGroups,f(),G()},function(n){e.error(n)}),a}function d(){var n=t.getSensorTypes();return n.then(function(e){g(e.data.sensorTypes),G()},function(n){e.error(n)}),n}function p(){Y={type:"since",range:{from:null,to:null},point:null,pointReadings:[],inputs:{since:{value:4,quantifier:"weeks",options:["hours","days","weeks","months"]},range:{from:{date:"",time:""},to:{date:"",time:""}},point:{date:"",time:""}}}}function l(){X.series=[],X.labels=[],X.data=[[null]]}function f(){if(W){for(var e=[],n=[],t=0;t<W.length;t++){var r=W[t];e.push(r.id);for(var o=m(r),a=0;a<r.buoyInstances.length;a++){var s=r.buoyInstances[a];n.push(s.id),y(s,o)}}v(e),w(n)}}function g(e){for(var n=0;n<e.length;n++){var t=e[n];F.hasOwnProperty(t.id)||(t.inputs={enabled:!1,options:[">","<","="],selected:">",value:""},F[t.id]=t)}}function m(e){var n={},t=h(e.id);return-1!=t?n=V[t]:(n.id=e.id,n.name=e.name,n.enabled=!0,n.collapsed=!1,n.indeterminate=!1,n.buoyInstances=[],V.push(n)),n.name=e.name,n}function y(e,n){var t={},r=h(n.id),o=b(e.id,n.id);return-1!=o?t=V[r].buoyInstances[o]:(t.id=e.id,t.enabled=!0,n.buoyInstances.push(t)),t.name=e.name,t}function h(e){for(var n=0;n<V.length;n++)if(V[n].id==e)return n;return-1}function b(e,n){var t=h(n);if(-1==t)return-1;for(var r=0;r<V[t].buoyInstances.length;r++)if(V[t].buoyInstances[r].id==e)return r;return-1}function v(e){for(var n=[],t=0;t<V.length;t++){var r=V[t];-1==e.indexOf(r.id)&&n.push(t)}for(var t=0;t<n.length;t++)V.splice(n[t],1)}function w(e){for(var n=[],t=0;t<V.length;t++)for(var r=V[t],o=0;o<r.buoyInstances.length;o++){var a=r.buoyInstances[o];-1==e.indexOf(a.id)&&n.push({group:t,instance:o})}for(var t=0;t<n.length;t++)V[n[t].group].splice(n[t].instance,1)}function I(e){e.buoyInstances.forEach(function(n){n.enabled=e.enabled}),G()}function T(e){B(e),G()}function B(e){var n=!0,t=!0;e.buoyInstances.forEach(function(e){e.enabled?t=!1:n=!1}),t?e.enabled=!1:e.enabled=!0,t||n?e.indeterminate=!1:e.indeterminate=!0}function x(){var e=n.defer();if(S()){var t=Z+" "+K;"range"==Y.type?(Y.range.from=o(Y.inputs.range.from.date+" "+Y.inputs.range.from.time,t),Y.range.to=o(Y.inputs.range.to.date+" "+Y.inputs.range.to.time,t)):"point"==Y.type&&(Y.point=o(Y.inputs.point.date+" "+Y.inputs.point.time,t)),N().then(function(){e.resolve()},function(){e.reject()})}return e.promise}function S(){if("since"==Y.type&&Y.inputs.since.value)return!0;if("range"==Y.type){var e=Y.inputs.range.from.date,n=Y.inputs.range.from.time,t=Y.inputs.range.to.date,r=Y.inputs.range.to.time;if(e&&n&&t&&r)return!0;if(e&&!n&&t&&!r)return!0}return"point"==Y.type&&Y.inputs.point.date?!0:!1}function N(){var e,n;"since"==Y.type?(e=o().subtract(Y.inputs.since.value,Y.inputs.since.quantifier).unix(),n=o().unix()):"all"==Y.type?(e=0,n=o().unix()):"range"==Y.type?(e=Y.range.from.unix(),n=Y.range.to.unix()):"point"==Y.type&&(e=Y.point.clone().subtract(2,"weeks").unix(),n=Y.point.clone().add(2,"weeks").unix());var t=c(e,n);return t.then(function(){"point"==Y.type&&C()}),t}function $(){G()}function C(){Y.pointReadings=[],W&&W.forEach(function(e){e.buoyInstances.forEach(function(e){var n={id:e.readings[0].id,timestamp:e.readings[0].timestamp};e.readings.forEach(function(e){var t=o.unix(n.timestamp).diff(Y.point),r=o.unix(e.timestamp).diff(Y.point);Math.abs(r)<Math.abs(t)&&(n.id=e.id,n.timestamp=e.timestamp)}),Y.pointReadings.push(n.id)})})}function G(){if(z=[],W.length&&Object.keys(F).length){for(var e=0;e<W.length;e++){var n=W[e];if(E(n.id))for(var t=j(n),r=0;r<n.buoyInstances.length;r++){var o=n.buoyInstances[r];if(R(o.id,n.id))for(var a=k(o,t),s=0;s<o.readings.length;s++){var i=o.readings[s];P(i)&&a.readings.push(i)}}}J()}}function E(e){return V[h(e)].enabled}function R(e,n){var t=h(n),r=b(e,n);return V[t].buoyInstances[r].enabled}function j(e){var n={};return z.push(n),n.id=e.id,n.name=e.name,n.buoyInstances=[],n}function k(e,n){var t={};return n.buoyInstances.push(t),t.id=e.id,t.name=e.name,t.readings=[],t}function P(e){return _(e)&&U(e)?!0:!1}function _(e){if("since"==Y.type){var n=o().subtract(Y.inputs.since.value,Y.inputs.since.quantifier),t=o.unix(e.timestamp);if(!t.isAfter(n))return!1}else if("range"==Y.type){var t=o.unix(e.timestamp);if(!t.isBetween(Y.range.from,Y.range.to))return!1}else if("point"==Y.type&&-1==Y.pointReadings.indexOf(e.id))return!1;return!0}function U(e){if(0===Object.keys(F).length)return!0;for(var n=0;n<e.sensorReadings.length;n++)if(!M(e.sensorReadings[n]))return!1;return!0}function M(e){var n=F[e.sensorTypeId].inputs;if(!n.enabled)return!0;var t=parseInt(n.value,10);if(">"==n.selected){if(e.value<=t)return!1}else if("<"==n.selected){if(e.value>=t)return!1}else if("="==n.selected&&e.value!=t)return!1;return!0}function D(e){var n=o.unix(e.timestamp);if("all"==Y.type)var t=o(),r=t.clone().subtract(2,"weeks");else if("since"==Y.type)var t=o(),r=o().subtract(Y.inputs.since.value,Y.inputs.since.quantifier);else if("range"==Y.type)var t=Y.range.to,r=Y.range.from;else if("point"==Y.type){if(null===Y.point)return 1;var t=Y.point,r=t.clone().subtract(2,"weeks")}return O(n,r,t)}function O(e,n,t){return e.isBefore(n)?0:e.isBefore(t)?e.diff(n)/t.diff(n):1}function A(){var e=[];z.forEach(function(n){n.buoyInstances.forEach(function(n){n.readings.forEach(function(n){e.push(n.id)})})}),t.exportData(e)}function L(e,n){var t=o.unix(e.timestamp).format("D MMMM h:mm A"),r="<div><h5><strong>"+n.name+"</strong></h5><em>"+t+"</em><br><table class='popup-table'><tbody>";return e.sensorReadings.forEach(function(e){r+="<tr><td>"+F[e.sensorTypeId].name+": </td><td class='right'>"+e.value+" "+F[e.sensorTypeId].unit+"</td></tr>"}),r+="</tbody></table></div>"}function J(){var e=[],n=0;z.forEach(function(t){t.buoyInstances.forEach(function(t){t.readings.forEach(function(o){e.push(o.id),r.showMarker(o,t,n,D(o),L(o,t))}),n++})}),r.hideDisabledMarkers(e)}function H(){for(var e=[],n=z,t=0;t<n.length;t++)for(var r=0;r<n[t].buoyInstances.length;r++){var a={};a.name=n[t].buoyInstances[r].name;for(var s=[],i=0;i<n[t].buoyInstances[r].readings.length;i++)for(var u=0;u<n[t].buoyInstances[r].readings[i].sensorReadings.length;u++)if(1==n[t].buoyInstances[r].readings[i].sensorReadings[u].sensorTypeId){var c=n[t].buoyInstances[r].readings[i].timestamp,d=o.unix(c).format("D/M h:mma"),p=n[t].buoyInstances[r].readings[i].sensorReadings[u].value;p>200&&(p=200),s.push({timeStamp:d,turbidity:p})}a.readings=s,e.push(a)}return console.log(e),e}function q(e){for(var n,t=H(),r=[],o=[],a=0;a<t.length;a++)if(t[a].name==e){n=[t[a].name];for(var s=0;s<t[a].readings.length;s++)o.push(t[a].readings[s].timeStamp),r.push(t[a].readings[s].turbidity)}if(o.length>100){o=o.slice(0,101);var i=Math.floor(o.length/10);console.log(i),X.labels.unshift("");for(var a=1;a<o.length;a++)a%i!=0&&(o[a]=""),console.log(o)}X.series=n,X.labels=o,X.labels.unshift(""),X.data=[r],X.data[0].unshift(r[0])}var W=[],z=[],F={},V=[],Y={},X={},Z="D/M/YY",K="h:mm A";return p(),l(),{buoys:a,times:s,sensors:i,chart:u,queryReadings:c,querySensors:d,selectBuoyGroup:I,selectBuoyInstance:T,updateTimes:x,updateSensors:$,exportData:A,displayChartInstance:q}}angular.module("app.dashboard").factory("dashboard",e),e.$inject=["$log","$q","server","map","moment"]}(),function(){"use strict";function e(e,n,t){function r(){w.styles=h(),b=new t.maps.Map(document.getElementById("map-canvas"),w),t.maps.event.addListener(b,"zoom_changed",function(){w.zoom=b.getZoom()}),t.maps.event.addListener(b,"center_changed",function(){w.center=b.getCenter()}),t.maps.event.addListener(b,"maptypeid_changed",function(){w.mapTypeId=b.getMapTypeId()}),t.maps.event.addListener(b,"click",function(){B&&f()}),I={},T=[]}function o(){return b.getCenter()}function a(e){t.maps.event.trigger(b,"resize"),b.setCenter(e)}function s(e,n,t,r,o){var a=e.id;I.hasOwnProperty(a)?-1!=T.indexOf(a)&&d(a):u(e,n,o),I[a].setIcon(g(m(t))),I[a].setOpacity(y(r))}function i(e){for(var n in I)I.hasOwnProperty(n)&&(n=parseInt(n,10),-1==e.indexOf(n)&&p(n))}function u(e,n,r){var o=c(e.latitude),a=c(e.longitude),s=new t.maps.Marker({position:new t.maps.LatLng(o,a),map:b});t.maps.event.addListener(s,"click",function(){l(e,n,s,r)}),I[e.id]=s}function c(e){var n=1e5;return Math.random()<.5?e+=Math.round(100*Math.random())/n:e-=Math.round(100*Math.random())/n,e}function d(e){I[e].setMap(b),T.splice(T.indexOf(e),1)}function p(e){I[e].setMap(null),T.push(e),B&&-1!=T.indexOf(x)&&f()}function l(n,r,o,a){B&&(f(),n.id==x)||(e.$broadcast("displayChartInstance",r),v=new InfoBox({content:a,pixelOffset:new t.maps.Size(-90,0),zIndex:null,closeBoxMargin:"-6px -6px 2px 2px"}),v.open(b,o),B=!0,x=n.id)}function f(){v.close(),B=!1}function g(e){return new t.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|"+e.substr(1),new t.maps.Size(21,34),new t.maps.Point(0,0),new t.maps.Point(10,34))}function m(e){var n=["#84CBD1","#CC4B30","#BF54D0","#70D84C","#36362B","#CD4075","#553264","#CBCC92","#D2983C","#6B7AD0","#C78378","#5A8A37","#CCD446","#72DA9E","#598369","#6D292F","#CAB3CC","#785F2A","#596C87","#C471B4"];return n[e%n.length]}function y(e){var n=.3;return e*(1-n)+n}function h(){return[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#0B5B91"},{visibility:"on"}]}]}var b,v,w={zoom:11,center:new t.maps.LatLng(-27.573704,153.055818),mapTypeId:t.maps.MapTypeId.ROADMAP},I={},T=[],B=!1,x=-1;return{initialiseMap:r,getCenter:o,setCenter:a,showMarker:s,hideDisabledMarkers:i}}angular.module("app.dashboard").factory("map",e),e.$inject=["$rootScope","$log","google"]}(),function(){"use strict";angular.module("app.gui").config(["$datepickerProvider","$timepickerProvider","$httpProvider","$alertProvider",function(e,n,t,r){t.interceptors.push("authInterceptor"),angular.extend(e.defaults,{autoclose:!0,dateFormat:"dd/MM/yy",modelDateFormat:"dd/MM/yy",dateType:"string",startWeek:1}),angular.extend(n.defaults,{autoclose:!1,timeFormat:"h:mm a",modelTimeFormat:"h:mm a",timeType:"string"}),angular.extend(r.defaults,{placement:"alert-placement",duration:3,container:"#page",show:!0})}])}(),function(){"use strict";function e(e,n,t){function r(n){e({title:"Success!",content:n,type:"success"})}function o(n){e({title:"Error:",content:n,type:"danger"})}function a(e){t.error(e),o(e.data+"("+e.status+")");
}function s(e){n({scope:e,templateUrl:"/app/gui/delete.modal.html",show:!0})}return{alertSuccess:r,alertError:o,alertBadResponse:a,confirmDelete:s}}angular.module("app.gui").factory("gui",e),e.$inject=["$alert","$modal","$log"]}(),function(){"use strict";function e(e,n,t,r){function o(){e.$on("$stateChangeSuccess",function(){d=r.loggedIn()})}function a(e){return t.stateActive(e)}function s(e){switch(e){case"dashboard":return d;case"config":return r.checkUser("power_user");case"warnings":return d;case"admin":return r.checkUser("system_admin");case"logout":return d;case"account":return d;default:return!1}}function i(){r.logout(),d=!1,n.go("login")}function u(){n.go("change_password")}var c=this,d=r.loggedIn();c.accountMenu=[{text:"Change password",click:"vm.changePassword()"},{text:"Logout",click:"vm.logout()"}],c.checkShowNav=s,c.stateActive=a,c.logout=i,c.changePassword=u,o()}angular.module("app.nav").controller("NavController",e),e.$inject=["$rootScope","$state","routerHelper","auth"]}(),function(){"use strict";function e(e,n,t){function r(){u.loading=!0,o(),a(),s()}function o(){n.getWarnings().then(function(e){u.warnings=e.data.warnings,c++,i()},function(n){e.error(n)})}function a(){n.getBuoyInstances().then(function(e){u.buoyInstances=e.data.buoyInstances,c++,i()},function(n){e.error(n)})}function s(){n.getSensorTypes().then(function(e){u.sensorTypes=e.data.sensorTypes,c++,i()},function(n){e.error(n)})}function i(){3>c||(u.loading=!1,u.warnings.forEach(function(e){e.readingTime=t(e.readingTimestamp,"X").format("DD/MM/YY HH:mm A");for(var n=0;n<u.buoyInstances.length;n++){var r=u.buoyInstances[n];if(r.id==e.warningTrigger.buoyInstanceId){e.buoyName=r.name;break}}for(var n=0;n<u.sensorTypes.length;n++){var o=u.sensorTypes[n];if(o.id==e.warningTrigger.sensorTypeId){e.sensorName=o.name;break}}e.warning=e.sensorName+" "+e.warningTrigger.operator+" "+e.warningTrigger.value}))}var u=this,c=0;u.loading=!1,u.warnings=[],u.buoyInstances=[],u.sensorTypes=[],r()}angular.module("app.warnings").controller("WarningsController",e),e.$inject=["$log","server","moment"]}(),function(){"use strict";function e(e){e.configureStates(n())}function n(){return[{state:"warnings",config:{url:"/warnings",controller:"WarningsController",controllerAs:"vm",templateUrl:"/app/warnings/warnings.html",data:{access:"authed"}}}]}angular.module("app.warnings").run(e),e.$inject=["routerHelper"]}();